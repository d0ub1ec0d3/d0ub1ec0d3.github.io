<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="SPN与内网渗透"><meta name="keywords" content="内网渗透"><meta name="author" content="rootrain"><meta name="copyright" content="rootrain"><title>SPN与内网渗透 | rootrain's Home</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SPN的意义及在redteam中的使用"><span class="toc-number">2.</span> <span class="toc-text">SPN的意义及在redteam中的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SPN的格式"><span class="toc-number">2.1.</span> <span class="toc-text">SPN的格式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kerberoast"><span class="toc-number">2.2.</span> <span class="toc-text">Kerberoast</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Kerberos协议认证"><span class="toc-number">2.2.1.</span> <span class="toc-text">Kerberos协议认证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SPN-在身份验证过程中所起的作用"><span class="toc-number">2.2.2.</span> <span class="toc-text">SPN 在身份验证过程中所起的作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#域内的主机都能查询SPN"><span class="toc-number">2.2.3.</span> <span class="toc-text">域内的主机都能查询SPN</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#域内的任何用户都可以向域内的任何服务请求TGS"><span class="toc-number">2.2.4.</span> <span class="toc-text">域内的任何用户都可以向域内的任何服务请求TGS</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结"><span class="toc-number">3.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考资料"><span class="toc-number">4.</span> <span class="toc-text">参考资料</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">rootrain</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">2</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">2</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">2</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">rootrain's Home</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives/">Archives</a><a class="site-page" href="/tags/">Tags</a><a class="site-page" href="/categories/">Categories</a></span></div><div id="post-info"><div id="post-title">SPN与内网渗透</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-05-01</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/内网渗透/">内网渗透</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>服务主体名称（SPN）是Kerberos客户端用于唯一标识给特定Kerberos目标计算机的服务实例名称。服务主体名称（SPN）是服务实例的唯一标识符。<a href="https://docs.microsoft.com/zh-cn/windows/desktop/ad/mutual-authentication-using-kerberos" target="_blank" rel="noopener">Kerberos身份验证</a>使用SPN将服务实例与服务登录帐户相关联。这允许客户端应用程序请求服务验证帐户，即使客户端没有帐户名。</p>
<p>根据微软的解释：可以创建两种类型的SPN：一种是基于主机的，另一种是任意的。在Active Directory中创建新计算机帐户时，将自动为内置服务生成基于主机的SPN。这些服务的示例包括HOST，LDAP和HTTP。实际上，SPN仅为HOST服务创建，所有内置服务都使用HOST SPN。但是，此实现是透明的，因为内置名称充当HOST服务的别名，除非它们已专门映射到Windows帐户。</p>
<a id="more"></a>
<h1 id="SPN的意义及在redteam中的使用"><a href="#SPN的意义及在redteam中的使用" class="headerlink" title="SPN的意义及在redteam中的使用"></a>SPN的意义及在redteam中的使用</h1><h2 id="SPN的格式"><a href="#SPN的格式" class="headerlink" title="SPN的格式"></a>SPN的格式</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">serviceclass/host:port/servicename</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<p><strong>·</strong> serviceclass可以理解为服务的名称，常见的有www, ldap, SMTP, DNS, HOST等。</p>
<p><strong>·</strong> host有两种形式，FQDN和NetBIOS名，例如server01.test.com和server01。</p>
<p><strong>·</strong> 如果服务运行在默认端口上，则端口号(port)可以省略。</p>
<p>eg：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TEST/pc-name.mydomain.com</span><br><span class="line">MSSQLSvc/DC1.test.com</span><br><span class="line">exchangeMDB/adsmsEXCAS01.adsecurity.org</span><br></pre></td></tr></table></figure>
<h2 id="Kerberoast"><a href="#Kerberoast" class="headerlink" title="Kerberoast"></a>Kerberoast</h2><h3 id="Kerberos协议认证"><a href="#Kerberos协议认证" class="headerlink" title="Kerberos协议认证"></a>Kerberos协议认证</h3><p>KDC包含AS、TGS</p>
<p><img src="E:/images/Visio-KerberosComms.png" alt></p>
<p>简单来说，clinet要访问server或者服务，需要client向AS请求ticket，然后使用ticket请求TGS，KDC将分发响应的session_key给client和与之建立联系的server</p>
<p>对于4.tgs_reply，用户将会收到由目标服务实例的NTLM hash加密生成的TGS(service ticket)，加密算法为<code>RC4-HMAC</code></p>
<p>站在利用的角度，当获得这个TGS后，我们可以尝试穷举口令，模拟加密过程，生成TGS进行比较。如果TGS相同，代表口令正确，就能获得目标服务实例的明文口令</p>
<h3 id="SPN-在身份验证过程中所起的作用"><a href="#SPN-在身份验证过程中所起的作用" class="headerlink" title="SPN 在身份验证过程中所起的作用"></a>SPN 在身份验证过程中所起的作用</h3><p><a href="https://docs.microsoft.com/zh-cn/sql/database-engine/configure-windows/register-a-service-principal-name-for-kerberos-connections?view=sql-server-2017" target="_blank" rel="noopener">以SQLSERVER为例子</a></p>
<p>当应用程序打开一个连接并使用 Windows 身份验证时， SQL Server Native Client 会传递 SQL Server 计算机名、实例名和 SPN（可选）。 如果该连接传递了 SPN，则使用它时不对它做任何更改。</p>
<p>如果该连接未传递 SPN，则将根据所使用的协议、服务器名和实例名构造一个默认的 SPN。</p>
<p>在上面这两种情况下，都会将 SPN 发送到密钥分发中心以获取用于对连接进行身份验证的安全标记。 如果无法获取安全标记，则身份验证采用 NTLM。</p>
<p>服务主体名称 (SPN) 是客户端用来唯一标识服务实例的名称。 Kerberos 身份验证服务可以使用 SPN 对服务进行身份验证。 当客户端想要连接到某个服务时，它将查找该服务的实例，并为该实例编写 SPN，然后连接到该服务并显示该服务的 SPN 以进行身份验证。</p>
<p>Windows 身份验证是向 SQL Server 验证用户身份的首选方法。 使用 Windows 身份验证的客户端通过 NTLM 或 Kerberos 进行身份验证。 在 Active Directory 环境中，始终首先尝试 Kerberos 身份验证。 Kerberos 身份验证不可用于使用命名管道的 SQL Server 2005 客户端。</p>
<h3 id="域内的主机都能查询SPN"><a href="#域内的主机都能查询SPN" class="headerlink" title="域内的主机都能查询SPN"></a>域内的主机都能查询SPN</h3><p>使用脚本查询SPN</p>
<p>SETSPN</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">setspn -T pentestlab -Q */*</span><br></pre></td></tr></table></figure>
<p><img src="/images/setspn-service-discovery.png" alt></p>
<p>GetUserSPNs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell_import /root/Desktop/GetUserSPNs.ps1</span><br></pre></td></tr></table></figure>
<p><img src="/images/getuserspns-powershell-script.png" alt></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cscript.exe GetUserSPNs.vbs</span><br></pre></td></tr></table></figure>
<p><img src="/images/getuserspns-vbs-script-cmd.png" alt></p>
<h3 id="域内的任何用户都可以向域内的任何服务请求TGS"><a href="#域内的任何用户都可以向域内的任何服务请求TGS" class="headerlink" title="域内的任何用户都可以向域内的任何服务请求TGS"></a>域内的任何用户都可以向域内的任何服务请求TGS</h3><ol>
<li><p>请求TGS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$SPNName = &apos;MSSQLSvc/DC1.test.com&apos;</span><br><span class="line">Add-Type -AssemblyNAme System.IdentityModel</span><br><span class="line">New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $SPNName</span><br></pre></td></tr></table></figure>
</li>
<li><p>导出TGS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::list /export</span><br></pre></td></tr></table></figure>
</li>
<li><p>暴力破解</p>
<p><a href="https://github.com/nidem/kerberoast/blob/master/tgsrepcrack.py" target="_blank" rel="noopener">https://github.com/nidem/kerberoast/blob/master/tgsrepcrack.py</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./tgsrepcrack.py wordlist.txt test.kirbi</span><br></pre></td></tr></table></figure>
<p>另一种利用方式参考：<a href="https://3gstudent.github.io/3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-Kerberoasting/" target="_blank" rel="noopener">https://3gstudent.github.io/3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-Kerberoasting/</a></p>
</li>
</ol>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>1.在 Active Directory 环境中，始终首先尝试 Kerberos 身份验证。如果使用IP或无法找寻SPN，将走NTLM协议。</p>
<p>2.SPN扫描发现资产，收集信息，快速定位存在可能脆弱的服务</p>
<p>3.破解TGS TICKETS</p>
<p>4.发现SPN是通过LDAP查询的</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p><a href="https://3gstudent.github.io/3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-Kerberoasting/" target="_blank" rel="noopener">https://3gstudent.github.io/3gstudent.github.io/%E5%9F%9F%E6%B8%97%E9%80%8F-Kerberoasting/</a></p>
<p><a href="http://www.cnblogs.com/backlion/p/8082623.html" target="_blank" rel="noopener">http://www.cnblogs.com/backlion/p/8082623.html</a></p>
<p><a href="https://www.harmj0y.net/blog/powershell/kerberoasting-without-mimikatz/" target="_blank" rel="noopener">https://www.harmj0y.net/blog/powershell/kerberoasting-without-mimikatz/</a></p>
<p><a href="https://pentestlab.blog/2018/06/04/spn-discovery/" target="_blank" rel="noopener">https://pentestlab.blog/2018/06/04/spn-discovery/</a></p>
<p><a href="https://pentestlab.blog/2018/06/12/kerberoast/" target="_blank" rel="noopener">https://pentestlab.blog/2018/06/12/kerberoast/</a></p>
<p><a href="https://docs.microsoft.com/zh-cn/sql/reporting-services/report-server/register-a-service-principal-name-spn-for-a-report-server?view=sql-server-2017" target="_blank" rel="noopener">https://docs.microsoft.com/zh-cn/sql/reporting-services/report-server/register-a-service-principal-name-spn-for-a-report-server?view=sql-server-2017</a></p>
<p><a href="https://docs.microsoft.com/zh-cn/windows/desktop/ad/service-principal-names" target="_blank" rel="noopener">https://docs.microsoft.com/zh-cn/windows/desktop/ad/service-principal-names</a></p>
<p><a href="https://adsecurity.org/?p=3458" target="_blank" rel="noopener">https://adsecurity.org/?p=3458</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">rootrain</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://rootrain.me/2019/05/01/SPN与内网渗透/">https://rootrain.me/2019/05/01/SPN与内网渗透/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/内网渗透/">内网渗透</a></div><nav id="pagination"><div class="next-post pull-right"><a href="/2019/04/17/应急响应一些杂谈/"><span>应急响应一些杂谈</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2019 By rootrain</div><div class="framework-info"></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script></body></html>